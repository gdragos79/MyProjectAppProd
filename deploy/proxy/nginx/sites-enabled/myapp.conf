# /etc/nginx/sites-enabled/myapp.conf
# Proxy that points to the currently active upstream via a symlink: /etc/nginx/upstreams/active.conf
#
# You will maintain two files:
#   /etc/nginx/upstreams/blue.conf  -> upstream active_app { server APP_BLUE_IP:80; }
#   /etc/nginx/upstreams/green.conf -> upstream active_app { server APP_GREEN_IP:80; }
# And 'active.conf' is a symlink to either blue.conf or green.conf.

# Load the 'active' upstream
include /etc/nginx/upstreams/active.conf;

server {
  listen 80;
  server_name _;

  # All traffic to the active upstream (both static and API)
  location / {
    proxy_pass http://active_app;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
