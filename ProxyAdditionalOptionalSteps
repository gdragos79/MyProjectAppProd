##########################################################
#Autostart on boot (systemd unit)
sudo tee /etc/systemd/system/myproject-proxy.service >/dev/null <<'UNIT'
[Unit]
Description=MyProject Proxy Stack (NGINX in Docker)
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
WorkingDirectory=/home/gdragos/proxy
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
UNIT

sudo systemctl daemon-reload
sudo systemctl enable --now myproject-proxy
######################################################
#Flip manually (handy for testing)
# To GREEN
cd /home/gdragos/proxy/nginx/upstreams
ln -sfn ../upstream-green.conf active.conf
echo "green" | sudo tee /var/lib/myproject/live_color
cd /home/gdragos/proxy && docker compose exec proxy nginx -s reload

# Back to BLUE
cd /home/gdragos/proxy/nginx/upstreams
ln -sfn ../upstream-blue.conf active.conf
echo "blue" | sudo tee /var/lib/myproject/live_color
cd /home/gdragos/proxy && docker compose exec proxy nginx -s reload
########################################################
